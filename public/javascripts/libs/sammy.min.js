// name: sammy
// version: 0.7.0
// Sammy.js / http://sammyjs.org
(function(a,b){var c,d="([^/]+)",e=/:([\w\d]+)/g,f=/\?([^#]*)?$/,g=function(a){return Array.prototype.slice.call(a)},h=function(a){return Object.prototype.toString.call(a)==="[object Function]"},i=function(a){return Object.prototype.toString.call(a)==="[object Array]"},j=function(a){return decodeURIComponent((a||"").replace(/\+/g," "))},k=encodeURIComponent,l=function(a){return String(a).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},m=function(a){return function(b,c){return this.route.apply(this,[a,b,c])}},n={},o=!!b.history&&!!history.pushState,p=[];c=function(){var b=g(arguments),d,e;c.apps=c.apps||{};if(b.length===0||b[0]&&h(b[0]))return c.apply(c,["body"].concat(b));if(typeof (e=b.shift())=="string")return d=c.apps[e]||new c.Application,d.element_selector=e,b.length>0&&a.each(b,function(a,b){d.use(b)}),d.element_selector!=e&&delete c.apps[e],c.apps[d.element_selector]=d,d},c.VERSION="0.7.0",c.addLogger=function(a){p.push(a)},c.log=function(){var b=g(arguments);b.unshift("["+Date()+"]"),a.each(p,function(a,d){d.apply(c,b)})},typeof b.console!="undefined"?h(b.console.log.apply)?c.addLogger(function(){b.console.log.apply(b.console,arguments)}):c.addLogger(function(){b.console.log(arguments)}):typeof console!="undefined"&&c.addLogger(function(){console.log.apply(console,arguments)}),a.extend(c,{makeArray:g,isFunction:h,isArray:i}),c.Object=function(b){return a.extend(this,b||{})},a.extend(c.Object.prototype,{escapeHTML:l,h:l,toHash:function(){var b={};return a.each(this,function(a,c){h(c)||(b[a]=c)}),b},toHTML:function(){var b="";return a.each(this,function(a,c){h(c)||(b+="<strong>"+a+"</strong> "+c+"<br />")}),b},keys:function(a){var b=[];for(var c in this)(!h(this[c])||!a)&&b.push(c);return b},has:function(b){return this[b]&&a.trim(this[b].toString())!==""},join:function(){var a=g(arguments),b=a.shift();return a.join(b)},log:function(){c.log.apply(c,arguments)},toString:function(b){var c=[];return a.each(this,function(a,d){(!h(d)||b)&&c.push('"'+a+'": '+d.toString())}),"Sammy.Object: {"+c.join(",")+"}"}}),c.DefaultLocationProxy=function(a,b){this.app=a,this.is_native=!1,this.has_history=o,this._startPolling(b)},c.DefaultLocationProxy.fullPath=function(a){var b=a.toString().match(/^[^#]*(#.+)$/),c=b?b[1]:"";return[a.pathname,a.search,c].join("")},c.DefaultLocationProxy.prototype={bind:function(){var d=this,e=this.app,f=c.DefaultLocationProxy;a(b).bind("hashchange."+this.app.eventNamespace(),function(a,c){d.is_native===!1&&!c&&(d.is_native=!0,b.clearInterval(f._interval)),e.trigger("location-changed")}),o&&!e.disable_push_state&&(a(b).bind("popstate."+this.app.eventNamespace(),function(a){e.trigger("location-changed")}),a("a").live("click.history-"+this.app.eventNamespace(),function(a){var c=f.fullPath(this);if(this.hostname==b.location.hostname&&e.lookupRoute("get",c))return a.preventDefault(),d.setLocation(c),!1})),f._bindings||(f._bindings=0),f._bindings++},unbind:function(){a(b).unbind("hashchange."+this.app.eventNamespace()),a(b).unbind("popstate."+this.app.eventNamespace()),a("a").die("click.history-"+this.app.eventNamespace()),c.DefaultLocationProxy._bindings--,c.DefaultLocationProxy._bindings<=0&&b.clearInterval(c.DefaultLocationProxy._interval)},getLocation:function(){return c.DefaultLocationProxy.fullPath(b.location)},setLocation:function(a){/^([^#\/]|$)/.test(a)&&(o?a="/"+a:a="#!/"+a);if(a!=this.getLocation())if(o&&/^\//.test(a))history.pushState({path:a},b.title,a),this.app.trigger("location-changed");else return b.location=a},_startPolling:function(d){var e=this;if(!c.DefaultLocationProxy._interval){d||(d=10);var f=function(){var d=e.getLocation();(typeof c.DefaultLocationProxy._last_location=="undefined"||d!=c.DefaultLocationProxy._last_location)&&b.setTimeout(function(){a(b).trigger("hashchange",[!0])},0),c.DefaultLocationProxy._last_location=d};f(),c.DefaultLocationProxy._interval=b.setInterval(f,d)}}},c.Application=function(a){var b=this;this.routes={},this.listeners=new c.Object({}),this.arounds=[],this.befores=[],this.namespace=(new Date).getTime()+"-"+parseInt(Math.random()*1e3,10),this.context_prototype=function(){c.EventContext.apply(this,arguments)},this.context_prototype.prototype=new c.EventContext,h(a)&&a.apply(this,[this]),this._location_proxy||this.setLocationProxy(new c.DefaultLocationProxy(this,this.run_interval_every)),this.debug&&this.bindToAllEvents(function(a,c){b.log(b.toString(),a.cleaned_type,c||{})})},c.Application.prototype=a.extend({},c.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:["run","unload","lookup-route","run-route","route-found","event-context-before","event-context-after","changed","error","check-form-submission","redirect","location-changed"],_last_route:null,_location_proxy:null,_running:!1,element_selector:"body",debug:!1,raise_errors:!1,run_interval_every:50,disable_push_state:!1,template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(b){return b?a(this.element_selector).find(b):a(this.element_selector)},use:function(){var a=g(arguments),b=a.shift(),d=b||"";try{a.unshift(this),typeof b=="string"&&(d="Sammy."+b,b=c[b]),b.apply(this,a)}catch(e){typeof b=="undefined"?this.error("Plugin Error: called use() but plugin ("+d.toString()+") is not defined",e):h(b)?this.error("Plugin Error",e):this.error("Plugin Error: called use() but '"+d.toString()+"' is not a function",e)}return this},setLocationProxy:function(a){var b=this._location_proxy;this._location_proxy=a,this.isRunning()&&(b&&b.unbind(),this._location_proxy.bind())},log:function(){c.log.apply(c,Array.prototype.concat.apply([this.element_selector],arguments))},route:function(b,c,f){var g=this,i=[],j,k;!f&&h(c)&&(c=b,f=c,b="any"),b=b.toLowerCase();if(c.constructor==String){e.lastIndex=0;while((k=e.exec(c))!==null)i.push(k[1]);c=new RegExp(c.replace(e,d)+"$")}return typeof f=="string"&&(f=g[f]),j=function(a){var b={verb:a,path:c,callback:f,param_names:i};g.routes[a]=g.routes[a]||[],g.routes[a].push(b)},b==="any"?a.each(this.ROUTE_VERBS,function(a,b){j(b)}):j(b),this},get:m("get"),post:m("post"),put:m("put"),del:m("delete"),any:m("any"),mapRoutes:function(b){var c=this;return a.each(b,function(a,b){c.route.apply(c,b)}),this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(a,b,c){var d=this;typeof c=="undefined"&&(c=b);var e=function(){var a,b,e;a=arguments[0],e=arguments[1],e&&e.context?(b=e.context,delete e.context):b=new d.context_prototype(d,"bind",a.type,e,a.target),a.cleaned_type=a.type.replace(d.eventNamespace(),""),c.apply(b,[a,e])};return this.listeners[a]||(this.listeners[a]=[]),this.listeners[a].push(e),this.isRunning()&&this._listen(a,e),this},trigger:function(a,b){return this.$element().trigger([a,this.eventNamespace()].join("."),[b]),this},refresh:function(){return this.last_location=null,this.trigger("location-changed"),this},before:function(a,b){return h(a)&&(b=a,a={}),this.befores.push([a,b]),this},after:function(a){return this.bind("event-context-after",a)},around:function(a){return this.arounds.push(a),this},isRunning:function(){return this._running},helpers:function(b){return a.extend(this.context_prototype.prototype,b),this},helper:function(a,b){return this.context_prototype.prototype[a]=b,this},run:function(c){if(this.isRunning())return!1;var d=this;return a.each(this.listeners.toHash(),function(b,c){a.each(c,function(a,c){d._listen(b,c)})}),this.trigger("run",{start_url:c}),this._running=!0,this.last_location=null,!/\#(.+)/.test(this.getLocation())&&typeof c!="undefined"&&this.setLocation(c),this._checkLocation(),this._location_proxy.bind(),this.bind("location-changed",function(){d._checkLocation()}),this.bind("submit",function(b){var c=d._checkFormSubmission(a(b.target).closest("form"));return c===!1?b.preventDefault():!1}),a(b).bind("beforeunload",function(){d.unload()}),this.trigger("changed")},unload:function(){if(!this.isRunning())return!1;var b=this;return this.trigger("unload"),this._location_proxy.unbind(),this.$element().unbind("submit").removeClass(b.eventNamespace()),a.each(this.listeners.toHash(),function(c,d){a.each(d,function(a,d){b._unlisten(c,d)})}),this._running=!1,this},bindToAllEvents:function(b){var c=this;return a.each(this.APP_EVENTS,function(a,d){c.bind(d,b)}),a.each(this.listeners.keys(!0),function(d,e){a.inArray(e,c.APP_EVENTS)==-1&&c.bind(e,b)}),this},routablePath:function(a){return a.replace(f,"")},lookupRoute:function(a,b){var c=this,d=!1,e=0,f,g;if(typeof this.routes[a]!="undefined"){f=this.routes[a].length;for(;e<f;e++){g=this.routes[a][e];if(c.routablePath(b).match(g.path)){d=g;break}}}return d},runRoute:function(b,c,d,e){var f=this,g=this.lookupRoute(b,c),h,i,k,l,m,n,o,p,q;this.log("runRoute",[b,c].join(" ")),this.trigger("run-route",{verb:b,path:c,params:d}),typeof d=="undefined"&&(d={}),a.extend(d,this._parseQueryString(c));if(g){this.trigger("route-found",{route:g}),(p=g.path.exec(this.routablePath(c)))!==null&&(p.shift(),a.each(p,function(a,b){g.param_names[a]?d[g.param_names[a]]=j(b):(d.splat||(d.splat=[]),d.splat.push(j(b)))})),h=new this.context_prototype(this,b,c,d,e),k=this.arounds.slice(0),m=this.befores.slice(0),o=[h].concat(d.splat),i=function(){var a;while(m.length>0){n=m.shift();if(f.contextMatchesOptions(h,n[0])){a=n[1].apply(h,[h]);if(a===!1)return!1}}return f.last_route=g,h.trigger("event-context-before",{context:h}),a=g.callback.apply(h,o),h.trigger("event-context-after",{context:h}),a},a.each(k.reverse(),function(a,b){var c=i;i=function(){return b.apply(h,[c])}});try{q=i()}catch(r){this.error(["500 Error",b,c].join(" "),r)}return q}return this.notFound(b,c)},contextMatchesOptions:function(a,b,c){var d=b;if(typeof d=="undefined"||d=={})return!0;typeof c=="undefined"&&(c=!0);if(typeof d=="string"||h(d.test))d={path:d};if(d.only)return this.contextMatchesOptions(a,d.only,!0);if(d.except)return this.contextMatchesOptions(a,d.except,!1);var e=!0,f=!0;return d.path&&(h(d.path.test)||(d.path=new RegExp(d.path.toString()+"$")),e=d.path.test(a.path)),d.verb&&(typeof d.verb=="string"?f=d.verb===a.verb:f=d.verb.indexOf(a.verb)>-1),c?f&&e:!f||!e},getLocation:function(){return this._location_proxy.getLocation()},setLocation:function(a){return this._location_proxy.setLocation(a)},swap:function(a){return this.$element().html(a)},templateCache:function(a,b){return typeof b!="undefined"?n[a]=b:n[a]},clearTemplateCache:function(){return n={}},notFound:function(a,b){var c=this.error(["404 Not Found",a,b].join(" "));return a==="get"?c:!0},error:function(a,b){b||(b=new Error),b.message=[a,b.message].join(" "),this.trigger("error",{message:b.message,error:b});if(this.raise_errors)throw b;this.log(b.message,b)},_checkLocation:function(){var a,b;a=this.getLocation();if(!this.last_location||this.last_location[0]!="get"||this.last_location[1]!=a)this.last_location=["get",a],b=this.runRoute("get",a);return b},_getFormVerb:function(b){var c=a(b),d,e;e=c.find('input[name="_method"]'),e.length>0&&(d=e.val()),d||(d=c[0].getAttribute("method"));if(!d||d=="")d="get";return a.trim(d.toString().toLowerCase())},_checkFormSubmission:function(b){var c,d,e,f,g;return this.trigger("check-form-submission",{form:b}),c=a(b),d=c.attr("action")||"",e=this._getFormVerb(c),this.log("_checkFormSubmission",c,d,e),e==="get"?(f=this._serializeFormParams(c),f!==""&&(d+="?"+f),this.setLocation(d),g=!1):(f=a.extend({},this._parseFormParams(c)),g=this.runRoute(e,d,f,b.get(0))),typeof g=="undefined"?!1:g},_serializeFormParams:function(a){var b="",c=a.serializeArray(),d;if(c.length>0){b=this._encodeFormPair(c[0].name,c[0].value);for(d=1;d<c.length;d++)b=b+"&"+this._encodeFormPair(c[d].name,c[d].value)}return b},_encodeFormPair:function(a,b){return k(a)+"="+k(b)},_parseFormParams:function(a){var b={},c=a.serializeArray(),d;for(d=0;d<c.length;d++)b=this._parseParamPair(b,c[d].name,c[d].value);return b},_parseQueryString:function(a){var b={},c,d,e,g;c=a.match(f);if(c){d=c[1].split("&");for(g=0;g<d.length;g++)e=d[g].split("="),b=this._parseParamPair(b,j(e[0]),j(e[1]||""))}return b},_parseParamPair:function(a,b,c){return typeof a[b]!="undefined"?i(a[b])?a[b].push(c):a[b]=[a[b],c]:a[b]=c,a},_listen:function(a,b){return this.$element().bind([a,this.eventNamespace()].join("."),b)},_unlisten:function(a,b){return this.$element().unbind([a,this.eventNamespace()].join("."),b)}}),c.RenderContext=function(a){this.event_context=a,this.callbacks=[],this.previous_content=null,this.content=null,this.next_engine=!1,this.waiting=!1},c.RenderContext.prototype=a.extend({},c.Object.prototype,{then:function(a){if(!h(a)){if(!(typeof a=="string"&&a in this.event_context))return this;var c=this.event_context[a];a=function(a){return c.apply(this.event_context,[a])}}var d=this;return this.waiting?this.callbacks.push(a):(this.wait(),b.setTimeout(function(){var b=a.apply(d,[d.content,d.previous_content]);b!==!1&&d.next(b)},0)),this},wait:function(){this.waiting=!0},next:function(a){this.waiting=!1,typeof a!="undefined"&&(this.previous_content=this.content,this.content=a),this.callbacks.length>0&&this.then(this.callbacks.shift())},load:function(b,c,d){var e=this;return this.then(function(){var f,g,i,j;h(c)?(d=c,c={}):c=a.extend({},c),d&&this.then(d);if(typeof b=="string")return i=b.match(/\.json$/)||c.json,f=i&&c.cache===!0||c.cache!==!1,e.next_engine=e.event_context.engineFor(b),delete c.cache,delete c.json,c.engine&&(e.next_engine=c.engine,delete c.engine),f&&(g=this.event_context.app.templateCache(b))?g:(this.wait(),a.ajax(a.extend({url:b,data:{},dataType:i?"json":null,type:"get",success:function(a){f&&e.event_context.app.templateCache(b,a),e.next(a)}},c)),!1);if(b.nodeType)return b.innerHTML;if(b.selector)return e.next_engine=b.attr("data-engine"),c.clone===!1?b.remove()[0].innerHTML.toString():b[0].innerHTML.toString()})},loadPartials:function(a){if(a){this.partials=this.partials||{};for(name in a)(function(b,c){b.load(a[c]).then(function(a){this.partials[c]=a})})(this,name)}return this},render:function(a,b,c,d){return h(a)&&!b?this.then(a):this.loadPartials(d).load(a).interpolate(b,a).then(c)},partial:function(a,b){return this.render(a,b).swap()},send:function(){var a=this,b=g(arguments),c=b.shift();return i(b[0])&&(b=b[0]),this.then(function(d){return b.push(function(b){a.next(b)}),a.wait(),c.apply(c,b),!1})},collect:function(b,c,d){var e=this,f=function(){h(b)&&(c=b,b=this.content);var d=[],f=!1;return a.each(b,function(a,b){var g=c.apply(e,[a,b]);return g.jquery&&g.length==1&&(g=g[0],f=!0),d.push(g),g}),f?d:d.join("")};return d?f():this.then(f)},renderEach:function(b,c,d,e){return i(c)&&(e=d,d=c,c=null),this.load(b).then(function(f){var g=this;d||(d=i(this.previous_content)?this.previous_content:[]);if(e)a.each(d,function(a,d){var h={},i=this.next_engine||b;c?h[c]=d:h=d,e(d,g.event_context.interpolate(f,h,i))});else return this.collect(d,function(a,d){var e={},g=this.next_engine||b;return c?e[c]=d:e=d,this.event_context.interpolate(f,e,g)},!0)})},interpolate:function(a,b,c){var d=this;return this.then(function(e,f){!a&&f&&(a=f),this.next_engine&&(b=this.next_engine,this.next_engine=!1);var g=d.event_context.interpolate(e,a,b,this.partials);return c?f+g:g})},swap:function(){return this.then(function(a){this.event_context.swap(a)}).trigger("changed",{})},appendTo:function(b){return this.then(function(c){a(b).append(c)}).trigger("changed",{})},prependTo:function(b){return this.then(function(c){a(b).prepend(c)}).trigger("changed",{})},replace:function(b){return this.then(function(c){a(b).html(c)}).trigger("changed",{})},trigger:function(a,b){return this.then(function(c){typeof b=="undefined"&&(b={content:c}),this.event_context.trigger(a,b)})}}),c.EventContext=function(a,b,d,e,f){this.app=a,this.verb=b,this.path=d,this.params=new c.Object(e),this.target=f},c.EventContext.prototype=a.extend({},c.Object.prototype,{$element:function(){return this.app.$element(g(arguments).shift())},engineFor:function(a){var b=this,c;if(h(a))return a;a=(a||b.app.template_engine).toString();if(c=a.match(/\.([^\.\?\#]+)$/))a=c[1];return a&&h(b[a])?b[a]:b.app.template_engine?this.engineFor(b.app.template_engine):function(a,b){return a}},interpolate:function(a,b,c,d){return this.engineFor(c).apply(this,[a,b,d])},render:function(a,b,d,e){return(new c.RenderContext(this)).render(a,b,d,e)},renderEach:function(a,b,d,e){return(new c.RenderContext(this)).renderEach(a,b,d,e)},load:function(a,b,d){return(new c.RenderContext(this)).load(a,b,d)},partial:function(a,b){return(new c.RenderContext(this)).partial(a,b)},send:function(){var a=new c.RenderContext(this);return a.send.apply(a,arguments)},redirect:function(){var b,c=g(arguments),d=this.app.getLocation(),e=c.length;if(e>1){var f=0,h=[],i=[],j={},k=!1;for(;f<e;f++)typeof c[f]=="string"?h.push(c[f]):(a.extend(j,c[f]),k=!0);b=h.join("/");if(k){for(var l in j)i.push(this.app._encodeFormPair(l,j[l]));b+="?"+i.join("&")}}else b=c[0];this.trigger("redirect",{to:b}),this.app.last_location=[this.verb,this.path],this.app.setLocation(b),(new RegExp(b)).test(d)&&this.app.trigger("location-changed")},trigger:function(a,b){return typeof b=="undefined"&&(b={}),b.context||(b.context=this),this.app.trigger(a,b)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(a){return this.app.swap(a)},notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(b){return a.parseJSON(b)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}}),a.sammy=b.Sammy=c})(jQuery,window);